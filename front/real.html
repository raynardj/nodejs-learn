<!DOCTYPE html>

<head>
    <!-- CSS only -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
    </script>
    <style>
        h2
        {
            font-size: 60px;
        }
        body,.form-control,label,h4
        {
            font-size: 40px;
        }
    </style>
</head>

<body>
    <div class="row">
        <div class="col-sm-1"></div>
        <div class="col-sm-10">


            <h2 class='mt-5'>
                上海买🧤二手房
            </h2>

            <div class='mt-5'>
                <ul class="list-group">
                    <li class="list-group-item">
                        <label for="price">总价(万)</label>
                        <input name='price' id="price" type="text" class='form-control'>
                    </li>
                    <li class="list-group-item">
                        <label for="price_last">卖方买入价</label>
                        <input name='price_last' id="price_last" value=0 
                        type="text" placeholder=0 class='form-control'>
                    </li>
                    <li class="list-group-item">
                        <label for="markprice">做差价(万) 可以负数</label>
                        <input name='markprice' id="markprice" value=0 
                        type="text" placeholder=0 class='form-control'>
                    </li>
                    
                    <li class="list-group-item">
                        <label for="price2">做价(万) 合同价</label>
                        <input name='price2' id="price2" value=0 
                        type="text" placeholder=0 class='form-control' readonly>
                    </li>
                    <li class="list-group-item">
                        <label for="realtype">住宅类型</label>
                        <select name="realtype" id="realtype" class='form-control'>
                            <option value="extraordi">非普通住宅</option>
                            <option value="oridi">普通住宅</option>
                        </select>
                    </li>
                    
                    <li class="list-group-item">
                        <label for="years">年份</label>
                        <select name="years" id="years" class='form-control'>
                            <option value="0">2 年不到</option>
                            <option value="1">2-5 年</option>
                            <option value="2">5 年以上</option>
                        </select>
                    </li>
                    <li class="list-group-item">
                        <label for="only">产权人家庭唯一</label>
                        <select name="only" id="only" class='form-control'>
                            <option value=0>不唯一</option>
                            <option value=1>唯一</option>
                        </select>
                    </li>
                    <li class="list-group-item">
                        <h4>贷款</h4>
                    </li>
                    <li class="list-group-item">
                        <label for="downpay">首付（万）</label>
                        <input name='downpay' id='downpay' type="text" class='form-control'>
                    </li>
                    <li class="list-group-item">
                        <label for="downpay_cash">首付实际现金（万，做价后）</label>
                        <input name='downpay_cash' id='downpay_cash' type="text" class='form-control' readonly>
                    </li>
                    <li class="list-group-item">
                        <label for="gov_loan">公积金贷款 (万)</label>
                        <input id='gov_loan' name='gov_loan' type="text" 
                        placeholder="100" value=100 class='form-control'>
                    </li>
                    <li class="list-group-item">
                        <label for="gov_rate">公积金贷款利率 (%)</label>
                        <input id='gov_rate' name='gov_rate' type="text" 
                        value=3.25
                        placeholder="100" default=100 class='form-control'>
                    </li>
                    <li class="list-group-item">
                        <label for="com_rate">商业金贷款利率 (%)</label>
                        <input id='com_rate' name='com_rate' type="text" 
                        value=4.9
                        placeholder="100" default=100 class='form-control'>
                    </li>
                    <li class="list-group-item">
                        <h4>
                            税费
                        </h4>
                    </li>
                    <li class="list-group-item">
                        <label for="vat">增值税</label>
                        <input type="text" name="vat" id="vat" class="form-control">
                    </li>
                    <li class="list-group-item">
                        <label for="pit">个税</label>
                        <input type="text" name="pit" id="pit" class="form-control">
                    </li>
                    <li class="list-group-item">
                        <label for="deedtax">契税</label>
                        <input type="text" name="deedtax" id="deedtax" class="form-control">
                    </li>
                    <li class="list-group-item">
                        <h4>
                            贷款
                        </h4>
                    </li>
                    <li class="list-group-item" id='loan_detail'>
                        
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-sm-1"></div>
    </div>
</body>
<script>
    $(document).ready(function(){

        const update_downpay = (price)=>{
            var downpay = price*0.35
            $("#downpay").val(downpay)
        }
        const calc_deedtax = (data)=>{
            const {price2} = data
            var deedtax = price2*0.01
            $("#deedtax").val(deedtax)
            return deedtax
        }

        const update_data = ()=>{
            var price = parseInt($("#price").val())
            var markprice = parseInt($("#markprice").val())
            var isordi = $("#realtype")[0].selectedIndex
            var years = $('#years')[0].selectedIndex
            var price_last = $('#price_last').val()
            var gov_loan = $('#gov_loan').val()
            var gov_rate = $('#gov_rate').val()/100
            var com_rate = $('#com_rate').val()/100
            
            console.log({price,markprice,isordi})
            $("#price2").val(price+markprice)
            price2 = price+markprice
            return {price2,isordi,markprice,years,price_last,
                gov_loan,gov_rate,com_rate}
        }

        const va_t = (va)=>{
            return (va/1.05)*0.056
        }

        const calc_vat = (data)=>{
            const {isordi,years,price2,price_last} = data
            if(isordi==1){ // ordinary
                if(years==0){// less than 2 years
                    return va_t(price2)
                }
                else{
                    return 0
                }
            }else{// not ordinary
                if(years==0){// less than 2 years
                    return va_t(price2)
                }else{ // mroe than 2 years
                    return va_t(price2-price_last)
                }
            }
        }

        const calc_PIT = (data)=>{
            // personal income tax
            const {only,price2,price_last,isordi} = data
            if (only ==1){
                return 0
            }else{
                const pit_rate = (isordi==1)?0.01:0.02;
                var t1 = (price2)*pit_rate;
                var t2 = (price2-price_last)*0.2
                return t1>t2?t2:t1
            }
        }

        
        const calc_compound = (borrow,I,year)=>{
            var amt = borrow
            var i  = I/12
            //var I= i * 12;
            var n = year * 12;
            var compound = Math.pow(1+i,n)
            monthly = (borrow*i*compound)/(compound-1)
            totalpay = (borrow*n*i*compound)/(compound-1)
            total_i = totalpay-borrow
            return {monthly,totalpay,total_i}
        }

        const calc_rate = (data)=>{
            const {price2,gov_loan,gov_rate,com_rate} = data
            if(price2*0.65>gov_loan){
                var gov_amt = gov_loan;
                var com_amt = price2*0.65-gov_amt;
            }
            else{
                var gov_amt = price2*0.65
                var com_amt = 0
            }
            gov = calc_compound(gov_amt,gov_rate,20)
            com = calc_compound(com_amt,com_rate,20)
            console.log({gov,com})
            return {gov,com}
        }
        const show_loan = (data)=>{

            var content = `
            <ul class = 'list-group'>
                <li class='list-group-item'>
                月还款:${data.gov.monthly.toFixed(3)}(公积金)
                + ${data.com.monthly.toFixed(3)}(商业)
                = ${(data.gov.monthly+data.com.monthly).toFixed(3)}
                </li>
                <li class='list-group-item'>
                    总利息:${data.gov.total_i.toFixed(3)}(公积金)
                    + ${data.com.total_i.toFixed(3)}(商业)
                    = ${(data.gov.total_i+data.com.total_i).toFixed(3)}
                </li>
                <li class='list-group-item'>
                    总还款:${data.gov.totalpay.toFixed(3)}(公积金)
                    + ${data.com.totalpay.toFixed(3)}(商业)
                    = ${(data.gov.totalpay+data.com.totalpay).toFixed(3)}
                </li>
            </ul>
            `
            $("#loan_detail").html(content)
        }
        const update_dpcash = ()=>{
            var downpay = parseFloat($("#downpay").val())
            var markprice = parseFloat($("#markprice").val())
            $("#downpay_cash").val((downpay-markprice).toFixed(2))
        }

        const update_all = ()=>{
            const data = update_data()
            
            update_downpay(data.price2)
            const deedtax = calc_deedtax(data)
            const vat = calc_vat(data)
            const pit = calc_PIT(data,vat)

            const loans = calc_rate(data)
            show_loan(loans)
            update_dpcash()

            $("#vat").val(vat)
            $("#pit").val(pit)
            console.log({vat,pit,deedtax})
        }
        const change_assign = (id_)=>{
            $(`#${id_}`).change(update_all)
        }
        window.calc_compound = calc_compound
        change_assign("markprice");
        change_assign("price");
        change_assign("price_last")
        change_assign("isordi")
        change_assign("realtype")
        change_assign("years")
        change_assign("only")
        change_assign("gov_rate")
        change_assign("com_rate")
    })
</script>